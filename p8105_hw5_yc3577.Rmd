---
title: "p8105_hw5_yc3577"
author: "Yimeng Cai"
date: "11/13/2023"
output: html_document
---

```{r}
library(tidyverse)
library(dbplyr)
library(readr)
library(purrr)
```

Problem 2
```{r}

file_names = 
  list.files(path = './data', 
             pattern = '.csv',
             full.names = TRUE)
file_names


df = 
  file_names |>
      map_dfr(~read_csv(.x)  |>
             mutate(subject_id = str_extract(.x, '\\d+'),
                    control_arm = str_extract(.x, 'con|exp')))
df

cleaned_df =
  df |>
  pivot_longer(
    week_1:week_8,
    names_to = 'week',
    values_to = 'observation'
  ) |>
    mutate(
    week = recode(week, 
                  'week_1' = '1',
                  'week_2' = '2',
                  'week_3' = '3',
                  'week_4' = '4',
                  'week_5' = '5',
                  'week_6' = '6',
                  'week_7' = '7',
                  'week_8' = '8'
                  )
  )
cleaned_df
```
```{r}
spa_plot = 
  ggplot(cleaned_df,
         aes(x = week, 
             y = observation,
             group = subject_id,
             color = control_arm)) +
  facet_wrap(~control_arm) +
  geom_line() +
  geom_point() +
  labs(title = 'Spaghetti Plot of Observations over Weeks',
       x = 'Week',
       y = 'Observation')

spa_plot
```

Problem 3

```{r}
set.seed(12345)

simulation = function(mu, sigma = 5, sample_size = 30) {

  data = rnorm(n = sample_size, mean = mu, sd = sigma)
  
  sim_data = tibble(
  mu_hat = mean(data),
  sigma_hat = sd(data)
  
  )

test = 
  t.test(data, alternative = 'two.sided', conf.level = 0.95) |>
  broom::tidy()

}

output = vector("list", 5000)

for (i in 1:5000) {
  output[[i]] = simulation(mu = 0)
}

sim_datasets = bind_rows(output)
sim_datasets


```
```{r}
# Repeat the above simulation for u ={1,2,3,4,5,6}
repetition =
  expand_grid(
    mu = c(1,2,3,4,5,6),
    iter = 1:5000
  ) |>
  mutate(
    estimate_df = map(mu, ~simulation(.x))
  ) |>
  unnest(estimate_df)

repetition
```



Make a plot showing the proportion of times the null was rejected (the power of the test) on the y axis and the true value of μ on the x axis. Describe the association between effect size and power.
```{r}
power_df = 
  repetition |>
  group_by(mu) |>
  summarise(
    p_value = mean(p.value < 0.05),
    sample_size = n(),
    proportion = p_value/sample_size
  )
power_df

power_plot = 
  power_df |>
  ggplot(aes(x = mu, y = proportion)) +
  geom_line() +
  geom_point() +
  geom_smooth() +
  labs(
    title = 'Proportion of Null Rejected over Mu',
    x = 'True Mean Value',
    y = 'Proportion'
  )

power_plot
```

Make a plot showing the average estimate of μ̂ on the y axis and the true value of μ on the x axis. Make a second plot (or overlay on the first) the average estimate of μ̂ only in samples for which the null was rejected on the y axis and the true value of μ on the x axis. 
```{r}

```

